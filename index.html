<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Excel ç›¤é»ç³»çµ±</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
            padding: 15px; padding-top: 60px; background-color: #f0f2f5; margin: 0;
            -webkit-overflow-scrolling: touch; 
        }

        /* é ‚éƒ¨å°è¦½åˆ— */
        .top-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 55px;
            background-color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; z-index: 1000;
        }
        .top-bar h1 { font-size: 1.1em; margin: 0; color: #333; }
        .btn-export {
            background-color: #17a2b8; color: white; border: none; padding: 8px 12px;
            border-radius: 5px; font-size: 0.9em; cursor: pointer;
        }

        .control-panel { 
            background: white; padding: 15px; border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; 
        }
        h2 { margin-top: 0; font-size: 1em; color: #666; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 10px;}

        /* è¡¨æ ¼å€ */
        #tableContainer {
            overflow-x: auto; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background: white; max-height: 55vh; overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { border: 1px solid #eee; padding: 12px 10px; text-align: center; font-size: 14px; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; z-index: 10; }
        
        td:nth-child(3) { font-weight: bold; color: #007bff; } 
        td:nth-child(4) { font-weight: bold; color: #28a745; background-color: #f9fff9; }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input[type="text"], input[type="file"] { 
            padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; 
            box-sizing: border-box; margin-bottom: 10px; font-size: 16px; 
        }
        .btn-action { 
            padding: 12px; background-color: #28a745; color: white; border: none; 
            border-radius: 8px; cursor: pointer; font-size: 16px; width: 100%; margin-bottom: 8px; 
        }
        #toggleCameraBtn { background-color: #6c757d; }
        
        .status-box { padding: 15px; font-weight: bold; border-radius: 8px; text-align: center; margin-top: 10px; display: none; }
        .bg-gray { background-color: #d3d3d3 !important; color: #555; }
        .bg-red { background-color: #ffebee !important; color: #c62828; }
        .bg-yellow { background-color: #fffde7 !important; color: #f57f17; }

        /* --- Quagga æƒæè¦–çª— CSS ä¿®æ”¹é‡é» --- */
        #interactive.viewport {
            position: relative; 
            width: 100%; 
            height: 180px; /* å›ºå®šé«˜åº¦ï¼Œç¸®å°è¦–çª— */
            overflow: hidden; /* éš±è—æº¢å‡ºçš„å½±åƒ */
            text-align: center; 
            display: none; 
            margin-bottom: 10px;
            background: #000; 
            border-radius: 8px;
        }
        /* è®“å½±ç‰‡å‚ç›´æ°´å¹³ç½®ä¸­ï¼Œä¿æŒç•«é¢ä¸­å¿ƒå¯è¦‹ */
        #interactive.viewport > video, #interactive.viewport > canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1>ğŸ“¦ ç›¤é»ç³»çµ±</h1>
        <button id="exportBtn" class="btn-export">åŒ¯å‡º</button>
    </div>

    <div class="control-panel">
       
        <input type="file" id="fileInput" accept=".xlsx, .xls" />
        <button id="importBtn" class="btn-action">åŒ¯å…¥è¡¨æ ¼</button>
        <p style="font-size: 0.8em; color: #888;"></p>
    </div>

    <div class="control-panel">
       
        
        <button id="toggleCameraBtn" class="btn-action">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
        
        <div id="interactive" class="viewport"></div>

        <input type="text" id="scanInput" placeholder="ç·¨è™Ÿ" inputmode="text" />
        <button id="checkBtn" class="btn-action">æ ¸å°</button>
        <div id="resultMessage" class="status-box"></div>
    </div>

    <div id="tableContainer"></div>

    <script>
        let excelData = [];
        let isCameraOn = false;
        let lastScannedCode = "";
        let lastScannedTime = 0;

        // 1. åŒ¯å‡º
        document.getElementById('exportBtn').addEventListener('click', function() {
            const table = document.getElementById('dataTable');
            if (!table) { alert("ç„¡è³‡æ–™"); return; }
            const now = new Date();
            const timeStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours()}${now.getMinutes()}`;
            const wb = XLSX.utils.table_to_book(table, {sheet: "ç›¤é»çµæœ", raw: true});
            XLSX.writeFile(wb, `ç›¤é»_${timeStr}.xlsx`);
        });

        // 2. åŒ¯å…¥
        document.getElementById('importBtn').addEventListener('click', function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) { alert("è«‹é¸æ“‡æª”æ¡ˆ"); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                renderTable(excelData);
                showStatus("åŒ¯å…¥æˆåŠŸ", "bg-yellow");
            };
            reader.readAsArrayBuffer(file);
        });

        function renderTable(data) {
            let html = '<table id="dataTable">';
            data.forEach((row, rowIndex) => {
                if (rowIndex === 0) {
                    html += '<thead><tr>';
                    for(let i=0; i<4; i++) {
                        let content = row[i] || (i===3 ? "å·²æƒæ" : "");
                        html += `<th>${content}</th>`;
                    }
                    html += '</tr></thead><tbody>';
                } else {
                    html += `<tr id="row-${rowIndex}">`;
                    for(let i=0; i < 4; i++) {
                        let val = row[i];
                        if (i === 3 && (val === undefined || val === null || val === '')) val = 0;
                        html += `<td contenteditable="${i!==3}">${val !== undefined ? val : ''}</td>`;
                    }
                    html += '</tr>';
                }
            });
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        // 3. Quagga æƒæ
        document.getElementById('toggleCameraBtn').addEventListener('click', function() {
            const viewport = document.getElementById('interactive');
            if (isCameraOn) {
                Quagga.stop();
                viewport.style.display = 'none';
                isCameraOn = false;
                this.innerText = "ğŸ“· é–‹å•Ÿç›¸æ©Ÿ";
                this.style.backgroundColor = "#6c757d";
            } else {
                viewport.style.display = 'block';
                this.innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
                this.style.backgroundColor = "#dc3545";

                Quagga.init({
                    inputStream: {
                        name: "Live", type: "LiveStream", target: document.querySelector('#interactive'),
                        constraints: { facingMode: "environment", width: { min: 640 }, height: { min: 480 }, aspectRatio: { min: 1, max: 2 } }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                    },
                    locate: true
                }, function(err) {
                    if (err) { alert("ç›¸æ©ŸéŒ¯èª¤: " + err); return; }
                    Quagga.start();
                    isCameraOn = true;
                });
            }
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            const now = new Date().getTime();
            if (code === lastScannedCode && (now - lastScannedTime < 1500)) return; 
            lastScannedCode = code;
            lastScannedTime = now;

            document.getElementById('scanInput').value = code;
            performCheck(true); 
        });

        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay, drawingCanvas = Quagga.canvas.dom.overlay;
            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(box => box !== result.box).forEach(box => {
                        Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                    });
                }
                if (result.box) Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                if (result.codeResult && result.codeResult.code) Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
            }
        });

        // 4. æ ¸å°é‚è¼¯
        document.getElementById('checkBtn').addEventListener('click', () => performCheck(false));
        document.getElementById('scanInput').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') performCheck(false); 
        });

        function performCheck(isFromCamera) {
            const inputEl = document.getElementById('scanInput');
            const inputVal = inputEl.value.trim();
            const table = document.getElementById('dataTable');

            if (!table) { alert("è«‹å…ˆåŒ¯å…¥è¡¨æ ¼"); return; }
            if (!inputVal) return;

            const rows = table.getElementsByTagName('tr');
            let found = false;

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                const col1Value = cells[0].innerText.trim();
                
                if (col1Value == inputVal) {
                    found = true;
                    let targetQty = parseFloat(cells[2].innerText.trim()) || 0;
                    let currentScanQty = parseFloat(cells[3].innerText.trim()) || 0;
                    let addQty = 0;

                    if (targetQty === 1) {
                        addQty = 1;
                        updateRow(rows[i], cells, currentScanQty, addQty, targetQty, col1Value);
                    } else {
                        setTimeout(() => {
                            let userStr = prompt(`ç·¨è™Ÿ ${col1Value}\nç›®æ¨™: ${targetQty} / å·²æƒ: ${currentScanQty}\nè«‹è¼¸å…¥å¢åŠ æ•¸é‡:`, "");
                            
                            if (userStr === null) {
                                inputEl.value = ""; 
                                return;
                            }
                            
                            addQty = (userStr.trim() === "") ? 1 : parseFloat(userStr);
                            if (isNaN(addQty)) { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
                            
                            updateRow(rows[i], cells, currentScanQty, addQty, targetQty, col1Value);
                        }, 50);
                    }
                    
                    rows[i].scrollIntoView({behavior: "smooth", block: "center"});
                    
                    // æ ¸å°æˆåŠŸ -> æ¸…ç©º
                    inputEl.value = ""; 
                    if (!isFromCamera) inputEl.focus(); 
                    
                    break;
                }
            }

            if (!found) {
                showStatus(`æŸ¥ç„¡ç·¨è™Ÿ: ${inputVal}`, "bg-red");
                // ä¿®æ”¹è™•ï¼šæ ¸å°å¤±æ•—ä¹Ÿè‡ªå‹•æ¸…ç©ºè¼¸å…¥æ¡†ï¼Œæ–¹ä¾¿ç¹¼çºŒè¼¸å…¥
                inputEl.value = "";
                // å¦‚æœæ˜¯æ‰‹å‹•è¼¸å…¥ï¼Œé‡æ–°å°ç„¦
                if (!isFromCamera) inputEl.focus();
            }
        }

        function updateRow(row, cells, currentQty, addQty, targetQty, col1Id) {
            let newTotal = currentQty + addQty;
            cells[3].innerText = newTotal;
            row.classList.remove('bg-gray', 'bg-red', 'bg-yellow');

            if (newTotal === targetQty) {
                row.classList.add('bg-gray');
                showStatus(`âœ… ${col1Id} å®Œæˆ`, "bg-gray");
            } else if (newTotal > targetQty) {
                row.classList.add('bg-red');
                showStatus(`âŒ ${col1Id} éŒ¯èª¤`, "bg-red");
            } else {
                row.classList.add('bg-yellow');
                showStatus(`ğŸ“¦ ${col1Id} +${addQty}`, "bg-yellow");
            }
        }

        function showStatus(text, cssClass) {
            const msgBox = document.getElementById('resultMessage');
            msgBox.innerText = text;
            msgBox.className = "status-box " + cssClass;
            msgBox.style.display = "block";
        }
    </script>
</body>

</html>
