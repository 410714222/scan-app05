<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›¤é»</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
            padding: 10px; 
            background-color: #f4f5f7; 
            margin: 0;
            -webkit-overflow-scrolling: touch; 
        }

        /* é€šç”¨é¢æ¿æ¨£å¼ (æ›´ç·Šæ¹Š) */
        .compact-panel { 
            background: white; 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 10px; 
        }

        /* å½ˆæ€§ä½ˆå±€åˆ— (ç”¨æ–¼ä¸¦æ’æŒ‰éˆ•) */
        .flex-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* æª”æ¡ˆæ§åˆ¶æŒ‰éˆ• */
        .btn-file {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            text-align: center;
        }
        #btn-import-trigger { background-color: #28a745; } /* ç¶ è‰² */
        #btn-export { background-color: #17a2b8; } /* è—ç¶ è‰² */

        /* ç›¸æ©ŸæŒ‰éˆ• */
        #toggleCameraBtn {
            width: 100%;
            padding: 10px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        /* è¼¸å…¥å€å¡Šä½ˆå±€ */
        .input-group {
            display: flex;
            gap: 5px;
        }
        #scanInput {
            flex: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            height: 40px; /* å›ºå®šé«˜åº¦ */
            box-sizing: border-box;
        }
        #checkBtn {
            width: 80px; /* å›ºå®šå¯¬åº¦ */
            height: 40px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        /* ç‹€æ…‹é¡¯ç¤º (æ›´ç²¾ç°¡) */
        .status-box { 
            padding: 8px; 
            font-weight: bold; 
            border-radius: 6px; 
            text-align: center; 
            margin-top: 8px; 
            font-size: 14px;
            display: none; 
        }
        .bg-gray { background-color: #e0e0e0; color: #555; }
        .bg-red { background-color: #ffebee; color: #c62828; }
        .bg-yellow { background-color: #fffde7; color: #f57f17; }

        /* ç›¸æ©Ÿè¦–çª— (é«˜åº¦ç¶­æŒç¸®å°) */
        #interactive.viewport {
            position: relative; 
            width: 100%; 
            height: 180px; 
            overflow: hidden; 
            background: #000; 
            border-radius: 6px;
            margin-bottom: 8px;
            display: none;
        }
        #interactive.viewport > video, #interactive.viewport > canvas {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            min-width: 100%; min-height: 100%; width: auto; height: auto;
        }

        /* è¡¨æ ¼å„ªåŒ– */
        #tableContainer {
            overflow-x: auto; 
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            /* è‡ªå‹•è¨ˆç®—é«˜åº¦ï¼šè¢å¹•é«˜åº¦ - ä¸Šæ–¹å€å¡Šå¤§ç´„é«˜åº¦ */
            height: calc(100vh - 190px); 
            overflow-y: auto;
        }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th, td { border: 1px solid #eee; padding: 10px 8px; text-align: center; font-size: 14px; }
        th { background-color: #007bff; color: white; position: sticky; top: 0; z-index: 10; }
        td:nth-child(3) { font-weight: bold; color: #007bff; } 
        td:nth-child(4) { font-weight: bold; color: #28a745; background-color: #f9fff9; }

        /* éš±è—çœŸå¯¦çš„ file input */
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="compact-panel">
        <div class="flex-row">
            <input type="file" id="fileInput" accept=".xlsx, .xls" />
            
            <button id="btn-import-trigger" class="btn-file" onclick="document.getElementById('fileInput').click();">
                ğŸ“‚ åŒ¯å…¥ Excel
            </button>
            <button id="btn-export" class="btn-file">
                â¬‡ åŒ¯å‡º
            </button>
        </div>
        <div id="importMsg" style="font-size: 12px; color: #666; margin-top: 5px; text-align: center; display: none;"></div>
    </div>

    <div class="compact-panel">
        <button id="toggleCameraBtn">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
        
        <div id="interactive" class="viewport"></div>

        <div class="input-group">
            <input type="text" id="scanInput" placeholder="è¼¸å…¥ç·¨è™Ÿ..." inputmode="text" />
            <button id="checkBtn">æ ¸å°</button>
        </div>
        
        <div id="resultMessage" class="status-box"></div>
    </div>

    <div id="tableContainer"></div>

    <script>
        let excelData = [];
        let isCameraOn = false;
        let lastScannedCode = "";
        let lastScannedTime = 0;

        // --- åŒ¯å‡ºåŠŸèƒ½ ---
        document.getElementById('btn-export').addEventListener('click', function() {
            const table = document.getElementById('dataTable');
            if (!table) { alert("ç„¡è³‡æ–™"); return; }
            const now = new Date();
            const timeStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours()}${now.getMinutes()}`;
            const wb = XLSX.utils.table_to_book(table, {sheet: "ç›¤é»çµæœ", raw: true});
            XLSX.writeFile(wb, `ç›¤é»_${timeStr}.xlsx`);
        });

        // --- åŒ¯å…¥åŠŸèƒ½ (ç›£è½éš±è—çš„ file input) ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                renderTable(excelData);
                
                // é¡¯ç¤ºåŒ¯å…¥æˆåŠŸçš„å°æç¤º
                const msgEl = document.getElementById('importMsg');
                msgEl.innerText = `âœ… å·²åŒ¯å…¥: ${file.name}`;
                msgEl.style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
            // æ¸…ç©º value è®“åŒæª”åå¯é‡è¤‡åŒ¯å…¥
            this.value = ''; 
        });

        function renderTable(data) {
            let html = '<table id="dataTable">';
            data.forEach((row, rowIndex) => {
                if (rowIndex === 0) {
                    html += '<thead><tr>';
                    for(let i=0; i<4; i++) {
                        let content = row[i] || (i===3 ? "å·²æƒ" : "");
                        html += `<th>${content}</th>`;
                    }
                    html += '</tr></thead><tbody>';
                } else {
                    html += `<tr id="row-${rowIndex}">`;
                    for(let i=0; i < 4; i++) {
                        let val = row[i];
                        if (i === 3 && (val === undefined || val === null || val === '')) val = 0;
                        html += `<td contenteditable="${i!==3}">${val !== undefined ? val : ''}</td>`;
                    }
                    html += '</tr>';
                }
            });
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        // --- Quagga ç›¸æ©Ÿæ§åˆ¶ ---
        document.getElementById('toggleCameraBtn').addEventListener('click', function() {
            const viewport = document.getElementById('interactive');
            if (isCameraOn) {
                Quagga.stop();
                viewport.style.display = 'none';
                isCameraOn = false;
                this.innerText = "ğŸ“· é–‹å•Ÿç›¸æ©Ÿ";
                this.style.backgroundColor = "#6c757d";
            } else {
                viewport.style.display = 'block';
                this.innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
                this.style.backgroundColor = "#dc3545";

                Quagga.init({
                    inputStream: {
                        name: "Live", type: "LiveStream", target: document.querySelector('#interactive'),
                        constraints: { facingMode: "environment", width: { min: 640 }, height: { min: 480 }, aspectRatio: { min: 1, max: 2 } }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                    },
                    locate: true
                }, function(err) {
                    if (err) { alert("ç›¸æ©ŸéŒ¯èª¤: " + err); return; }
                    Quagga.start();
                    isCameraOn = true;
                });
            }
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            const now = new Date().getTime();
            if (code === lastScannedCode && (now - lastScannedTime < 1500)) return; 
            lastScannedCode = code;
            lastScannedTime = now;

            document.getElementById('scanInput').value = code;
            performCheck(true); 
        });

        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay, drawingCanvas = Quagga.canvas.dom.overlay;
            if (result && result.boxes) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                result.boxes.filter(box => box !== result.box).forEach(box => {
                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                });
                if (result.box) Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                if (result.codeResult && result.codeResult.code) Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
            }
        });

        // --- æ ¸å°é‚è¼¯ ---
        document.getElementById('checkBtn').addEventListener('click', () => performCheck(false));
        document.getElementById('scanInput').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') performCheck(false); 
        });

        function performCheck(isFromCamera) {
            const inputEl = document.getElementById('scanInput');
            const inputVal = inputEl.value.trim();
            const table = document.getElementById('dataTable');

            if (!table) { alert("è«‹å…ˆåŒ¯å…¥è¡¨æ ¼"); return; }
            if (!inputVal) return;

            const rows = table.getElementsByTagName('tr');
            let found = false;

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                const col1Value = cells[0].innerText.trim();
                
                if (col1Value == inputVal) {
                    found = true;
                    let targetQty = parseFloat(cells[2].innerText.trim()) || 0;
                    let currentScanQty = parseFloat(cells[3].innerText.trim()) || 0;
                    let addQty = 0;

                    if (targetQty === 1) {
                        addQty = 1;
                        updateRow(rows[i], cells, currentScanQty, addQty, targetQty, col1Value);
                    } else {
                        setTimeout(() => {
                            let userStr = prompt(`ç·¨è™Ÿ ${col1Value}\nç›®æ¨™: ${targetQty} / å·²æƒ: ${currentScanQty}\nè«‹è¼¸å…¥å¢åŠ æ•¸é‡:`, "");
                            
                            if (userStr === null) {
                                inputEl.value = ""; 
                                return;
                            }
                            addQty = (userStr.trim() === "") ? 1 : parseFloat(userStr);
                            if (isNaN(addQty)) { alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
                            
                            updateRow(rows[i], cells, currentScanQty, addQty, targetQty, col1Value);
                        }, 50);
                    }
                    
                    rows[i].scrollIntoView({behavior: "smooth", block: "center"});
                    inputEl.value = ""; 
                    if (!isFromCamera) inputEl.focus(); 
                    break;
                }
            }

            if (!found) {
                showStatus(`æŸ¥ç„¡: ${inputVal}`, "bg-red");
                inputEl.value = "";
                if (!isFromCamera) inputEl.focus();
            }
        }

        function updateRow(row, cells, currentQty, addQty, targetQty, col1Id) {
            let newTotal = currentQty + addQty;
            cells[3].innerText = newTotal;
            row.classList.remove('bg-gray', 'bg-red', 'bg-yellow');

            if (newTotal === targetQty) {
                row.classList.add('bg-gray');
                showStatus(`âœ… ${col1Id} å®Œæˆ`, "bg-gray");
            } else if (newTotal > targetQty) {
                row.classList.add('bg-red');
                showStatus(`âŒ ${col1Id} éŒ¯èª¤`, "bg-red");
            } else {
                row.classList.add('bg-yellow');
                showStatus(`ğŸ“¦ ${col1Id} +${addQty}`, "bg-yellow");
            }
        }

        function showStatus(text, cssClass) {
            const msgBox = document.getElementById('resultMessage');
            msgBox.innerText = text;
            msgBox.className = "status-box " + cssClass;
            msgBox.style.display = "block";
        }
    </script>
</body>
</html>
