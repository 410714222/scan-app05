<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯ç‹—</title>
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>

    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", Roboto, sans-serif; 
            padding: 8px; 
            background-color: #f4f5f7; 
            margin: 0;
            -webkit-overflow-scrolling: touch; 
        }

        .compact-panel { 
            background: white; 
            padding: 10px; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 8px; 
        }

        /* æª”æ¡ˆæ§åˆ¶å€ */
        .flex-row { display: flex; gap: 8px; align-items: center; }
        .btn-file {
            flex: 1; padding: 10px; border: none; border-radius: 6px;
            font-size: 14px; font-weight: bold; cursor: pointer; color: white; text-align: center;
        }
        #btn-import-trigger { background-color: #28a745; }
        #btn-export { background-color: #dc3545; } /* æ”¹ç´…è‰²ï¼Œå¼·èª¿æ˜¯åŒ¯å‡ºå·®ç•° */

        /* ç›¸æ©ŸæŒ‰éˆ• */
        #toggleCameraBtn {
            width: 100%; padding: 10px; background-color: #6c757d; color: white;
            border: none; border-radius: 6px; font-size: 14px; margin-bottom: 8px; cursor: pointer;
        }

        /* è¼¸å…¥å€å¡Š */
        .input-group { display: flex; gap: 5px; }
        #scanInput {
            flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 6px;
            font-size: 16px; height: 40px; box-sizing: border-box;
        }
        #checkBtn {
            width: 70px; height: 40px; background-color: #007bff; color: white;
            border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
        }

        /* ç‹€æ…‹é¡¯ç¤º */
        .status-box { 
            padding: 8px; font-weight: bold; border-radius: 6px; text-align: center; 
            margin-top: 8px; font-size: 13px; display: none; 
        }
        .bg-gray { background-color: #e0e0e0; color: #555; }
        .bg-red { background-color: #ffebee; color: #c62828; }
        .bg-yellow { background-color: #fffde7; color: #f57f17; }

        /* ç›¸æ©Ÿè¦–çª— */
        #interactive.viewport {
            position: relative; width: 100%; height: 160px; overflow: hidden; 
            background: #000; border-radius: 6px; margin-bottom: 8px; display: none;
        }
        #interactive.viewport > video, #interactive.viewport > canvas {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            min-width: 100%; min-height: 100%; width: auto; height: auto;
        }

        /* è¡¨æ ¼å›ºå®šä½ˆå±€ */
        #tableContainer {
            background: white; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: calc(100vh - 450px); 
            overflow-y: auto; 
            overflow-x: hidden;
        }
        table { 
            width: 100%; table-layout: fixed; border-collapse: collapse; 
        }
        th, td { 
            border: 1px solid #eee; padding: 8px 4px; text-align: center; font-size: 13px; 
            white-space: normal; word-wrap: break-word; word-break: break-all; vertical-align: middle;
        }
        th { background-color: #007bff; color: white; position: sticky; top: 0; z-index: 10; }
        td:nth-child(3) { font-weight: bold; color: #007bff; } 
        td:nth-child(4) { font-weight: bold; color: #28a745; background-color: #f9fff9; }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="compact-panel">
        <div class="flex-row">
            <input type="file" id="fileInput" accept=".xlsx, .xls" />
            <button id="btn-import-trigger" class="btn-file" onclick="document.getElementById('fileInput').click();">
                ğŸ“‚ åŒ¯å…¥
            </button>
            <button id="btn-export" class="btn-file">
                âš  åŒ¯å‡ºå·®ç•°
            </button>
        </div>
        <div id="importMsg" style="font-size: 12px; color: #666; margin-top: 5px; text-align: center; display: none;"></div>
    </div>

    <div class="compact-panel">
        <button id="toggleCameraBtn">ğŸ“· é–‹å•Ÿç›¸æ©Ÿ</button>
        <div id="interactive" class="viewport"></div>

        <div class="input-group">
            <input type="number" id="scanInput" placeholder="é™è¼¸å…¥æ•¸å­—ç·¨è™Ÿ" inputmode="numeric" />
            <button id="checkBtn">æ ¸å°</button>
        </div>
        <div id="resultMessage" class="status-box"></div>
    </div>

    <div id="tableContainer"></div>

    <script>
        let excelData = [];
        let isCameraOn = false;
        let lastScannedCode = "";
        let lastScannedTime = 0;

        // --- å¼·åˆ¶åªèƒ½è¼¸å…¥æ•¸å­—çš„ç›£è½å™¨ ---
        const scanInputEl = document.getElementById('scanInput');
        scanInputEl.addEventListener('input', function() {
            // å°‡é 0-9 çš„å­—å…ƒå…¨éƒ¨æ›¿æ›ç‚ºç©ºå­—ä¸²
            this.value = this.value.replace(/[^0-9]/g, '');
        });

        // --- åŒ¯å‡ºåŠŸèƒ½ (ä¿®æ­£ï¼šåªåŒ¯å‡ºå·®ç•°) ---
        document.getElementById('btn-export').addEventListener('click', function() {
            const table = document.getElementById('dataTable');
            if (!table) { alert("ç„¡è³‡æ–™"); return; }
            
            // 1. æŠ“å–è¡¨æ ¼æ‰€æœ‰åˆ—
            const rows = table.querySelectorAll('tr');
            let exportData = [];
            let header = [];

            // 2. éæ­·è¡¨æ ¼
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('th, td');
                let rowData = [];
                // è®€å–è©²åˆ—æ‰€æœ‰æ ¼å­çš„æ–‡å­—
                cells.forEach(cell => {
                    // å¦‚æœæ˜¯ input/contenteditableï¼Œå– innerText
                    rowData.push(cell.innerText); 
                });

                if (index === 0) {
                    // æ¨™é¡Œåˆ—ï¼šæ°¸é ä¿ç•™
                    header = rowData;
                    exportData.push(rowData);
                } else {
                    // å…§å®¹åˆ—ï¼šé€²è¡Œæ¯”å°
                    // å‡è¨­ç¬¬3æ¬„æ˜¯ index 2, ç¬¬4æ¬„æ˜¯ index 3
                    // å°‡æ–‡å­—è½‰ç‚ºæ•¸å­—é€²è¡Œæ¯”è¼ƒ (é¿å… "10" å’Œ "10 " ä¸ç›¸ç­‰çš„æƒ…æ³)
                    let target = parseFloat(rowData[2]); 
                    let scanned = parseFloat(rowData[3]); 

                    // å¦‚æœè½‰å‡ºä¾†æ˜¯ NaN (ä¾‹å¦‚ç©ºå­—ä¸²)ï¼Œè¦–ç‚º 0
                    if (isNaN(target)) target = 0;
                    if (isNaN(scanned)) scanned = 0;

                    // æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœä¸ç›¸ç­‰ï¼Œæ‰åŠ å…¥åŒ¯å‡ºæ¸…å–®
                    if (target !== scanned) {
                        exportData.push(rowData);
                    }
                }
            });

            // 3. æª¢æŸ¥æ˜¯å¦æœ‰å·®ç•°è³‡æ–™
            if (exportData.length <= 1) { // åªæœ‰æ¨™é¡Œåˆ—ï¼Œä»£è¡¨å…¨éƒ¨æ­£ç¢º
                alert("æ­å–œï¼æ‰€æœ‰é …ç›®æ•¸é‡çš†ç›¸ç¬¦ï¼Œæ²’æœ‰å·®ç•°è³‡æ–™å¯åŒ¯å‡ºã€‚");
                return;
            }

            // 4. ç”¢ç”Ÿ Excel
            const now = new Date();
            const timeStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours()}${now.getMinutes()}`;
            
            // ä½¿ç”¨ aoa_to_sheet (Array of Arrays)
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "å·®ç•°çµæœ");
            XLSX.writeFile(wb, `ç›¤é»_${timeStr}.xlsx`);
        });

        // --- åŒ¯å…¥åŠŸèƒ½ ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                excelData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                renderTable(excelData);
                const msgEl = document.getElementById('importMsg');
                msgEl.innerText = `âœ… å·²åŒ¯å…¥: ${file.name}`;
                msgEl.style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
            this.value = ''; 
        });

        function renderTable(data) {
            let html = '<table id="dataTable">';
            data.forEach((row, rowIndex) => {
                if (rowIndex === 0) {
                    html += '<thead><tr>';
                    for(let i=0; i<4; i++) {
                        let content = row[i] || (i===3 ? "å·²æƒ" : "");
                        html += `<th>${content}</th>`;
                    }
                    html += '</tr></thead><tbody>';
                } else {
                    html += `<tr id="row-${rowIndex}">`;
                    for(let i=0; i < 4; i++) {
                        let val = row[i];
                        if (i === 3 && (val === undefined || val === null || val === '')) val = 0;
                        html += `<td contenteditable="${i!==3}">${val !== undefined ? val : ''}</td>`;
                    }
                    html += '</tr>';
                }
            });
            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        // --- ç›¸æ©Ÿé‚è¼¯ ---
        document.getElementById('toggleCameraBtn').addEventListener('click', function() {
            const viewport = document.getElementById('interactive');
            if (isCameraOn) {
                Quagga.stop();
                viewport.style.display = 'none';
                isCameraOn = false;
                this.innerText = "ğŸ“· é–‹å•Ÿç›¸æ©Ÿ";
                this.style.backgroundColor = "#6c757d";
            } else {
                viewport.style.display = 'block';
                this.innerText = "âŒ é—œé–‰ç›¸æ©Ÿ";
                this.style.backgroundColor = "#dc3545";

                Quagga.init({
                    inputStream: {
                        name: "Live", type: "LiveStream", target: document.querySelector('#interactive'),
                        constraints: { facingMode: "environment", width: { min: 640 }, height: { min: 480 }, aspectRatio: { min: 1, max: 2 } }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "upc_reader"]
                    },
                    locate: true
                }, function(err) {
                    if (err) { alert("ç›¸æ©ŸéŒ¯èª¤: " + err); return; }
                    Quagga.start();
                    isCameraOn = true;
                });
            }
        });

        Quagga.onDetected(function(result) {
            const code = result.codeResult.code;
            const now = new Date().getTime();
            if (code === lastScannedCode && (now - lastScannedTime < 1500)) return; 
            lastScannedCode = code;
            lastScannedTime = now;

            // ç¢ºä¿æƒåˆ°çš„ä¹Ÿæ˜¯æ•¸å­— (æœ‰äº›æ¢ç¢¼å¯èƒ½èª¤åˆ¤)
            if (!/^\d+$/.test(code)) return; 

            document.getElementById('scanInput').value = code;
            performCheck(true); 
        });

        Quagga.onProcessed(function(result) {
            var drawingCtx = Quagga.canvas.ctx.overlay, drawingCanvas = Quagga.canvas.dom.overlay;
            if (result && result.boxes) {
                drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                result.boxes.filter(box => box !== result.box).forEach(box => {
                    Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                });
                if (result.box) Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                if (result.codeResult && result.codeResult.code) Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
            }
        });

        document.getElementById('checkBtn').addEventListener('click', () => performCheck(false));
        document.getElementById('scanInput').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') performCheck(false); 
        });

        function performCheck(isFromCamera) {
            const inputEl = document.getElementById('scanInput');
            const inputVal = inputEl.value.trim();
            const table = document.getElementById('dataTable');

            if (!table) { alert("è«‹å…ˆåŒ¯å…¥è¡¨æ ¼"); return; }
            if (!inputVal) return;

            const rows = table.getElementsByTagName('tr');
            let found = false;

            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                const col1Value = cells[0].innerText.trim();
                
                if (col1Value == inputVal) {
                    found = true;
                    let targetQty = parseFloat(cells[2].innerText.trim()) || 0;
                    let currentScanQty = parseFloat(cells[3].innerText.trim()) || 0;
                    let addQty = 0;

                    if (targetQty === 1) {
                        addQty = 1;
                        updateRow(rows[i], cells, currentScanQty, addQty, targetQty, col1Value);
                    } else {
                        setTimeout(() => {
                            let userStr = prompt(`ç·¨è™Ÿ ${col1Value}\nç›®æ¨™: ${targetQty} / å·²æƒ: ${currentScanQty}\nè«‹è¼¸å…¥å¢åŠ æ•¸é‡ (é™æ•¸å­—):`, "");
                            
                            if (userStr === null) {
                                inputEl.value = ""; 
                                return;
                            }
                            
                            // ä¿®æ­£ï¼šæª¢æŸ¥è¼¸å…¥æ˜¯å¦ç‚ºç´”æ•¸å­—
                            userStr = userStr.trim();
                            if (!/^\d+$/.test(userStr)) {
                                alert("éŒ¯èª¤ï¼åªèƒ½è¼¸å…¥æ•¸å­—ã€‚");
                                inputEl.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
                                if (!isFromCamera) inputEl.focus();
                                return;
                            }

                            addQty = (userStr === "") ? 1 : parseFloat(userStr);
                            updateRow(rows[i], cells, currentScanQty, addQty, targetQty, col1Value);
                        }, 50);
                    }
                    
                    rows[i].scrollIntoView({behavior: "smooth", block: "center"});
                    inputEl.value = ""; 
                    if (!isFromCamera) inputEl.focus(); 
                    break;
                }
            }

            if (!found) {
                showStatus(`æŸ¥ç„¡ç·¨è™Ÿ: ${inputVal}`, "bg-red");
                inputEl.value = "";
                if (!isFromCamera) inputEl.focus();
            }
        }

        function updateRow(row, cells, currentQty, addQty, targetQty, col1Id) {
            let newTotal = currentQty + addQty;
            cells[3].innerText = newTotal;
            row.classList.remove('bg-gray', 'bg-red', 'bg-yellow');

            if (newTotal === targetQty) {
                row.classList.add('bg-gray');
                showStatus(`âœ… ${col1Id} å®Œæˆ`, "bg-gray");
            } else if (newTotal > targetQty) {
                row.classList.add('bg-red');
                showStatus(`âŒ ${col1Id} æ•¸é‡éŒ¯èª¤`, "bg-red");
            } else {
                row.classList.add('bg-yellow');
                showStatus(`ğŸ“¦ ${col1Id} +${addQty}`, "bg-yellow");
            }
        }

        function showStatus(text, cssClass) {
            const msgBox = document.getElementById('resultMessage');
            msgBox.innerText = text;
            msgBox.className = "status-box " + cssClass;
            msgBox.style.display = "block";
        }
    </script>
</body>
</html>
